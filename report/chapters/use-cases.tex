\newpage
\section{Use-cases}

The table below presents a range of potential use-cases for contracts that
utilize block timestamps and block numbers. It also provides a usage recommendation
for each use-case under both PoS and PoW frameworks. These contracts serve as
examples and focus solely on issues related to block values, excluding any
other types of vulnerabilities. Refer to Appendix (see Section \ref{appendix})
for the contracts code.

\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}}

\begin{table}[H]
  \centering
  \small % Reduce the font size
  \begin{tabularx}{\textwidth}{L{3.5cm}L{3.5cm}C{0.5cm}C{0.5cm}X} % Fixed width for the second column
    \hline
    \textbf{Contract Name} & \textbf{Contract Description}                                                                                                           & \textbf{PoW} & \textbf{PoS} & \textbf{Reason}                                                                                                                                                                                \\ \hline
    Firework               & A contract designed to activate New Year's fireworks precisely at 12 AM.                                                                & bad          & bad          & Precise timing cannot be achieved in either PoW or PoS systems.                                                                                                                                \\ \hline
    FastWithdrawChallenge  & The first individual to withdraw after a specified timestamp wins the money.                                                            & bad          & good         & In a PoW system, the block timestamp can be influenced by up to 15 seconds by a malicious miner.                                                                                               \\ \hline
    BlockNumberTimeLock    & A contract that locks Ethereum for a set period, utilizing block numbers as a proxy for time, based on an assumed 14-second block time. & bad          & bad          & In both PoW and PoS, the block time does not consistently maintain a 14-second duration.                                                                                                       \\ \hline
    BlockNumberLock        & A contract that locks Ethereum for a specified number of blocks without guaranteeing exact timing.                                      & good         & good         & In both PoS and PoW it is safe to use when it is clearly communicated to the user that a lock will be maintained for a specified number of blocks, without guaranteeing a specific time period \\ \hline
    Lottery                & Lottery contract, players are allowed to enter the lottery up until a certain timestamp.                                                & bad          & good         & In certain cases a malicious miner under PoW could be able to end the lottery up to 15 seconds earlier.                                                                                       \\ \hline                  
    StateMachine           & Multi-stage contract where certain actions are allowed only during specific phases.                                                     & bad          & good         & In PoW a malicious miner could trigger a stage up to 15 seconds earlier.                                                                                                                     \\ \hline
  \end{tabularx}
  \caption{Analysis of Various Smart Contracts}
  \label{tab:smart_contracts}
\end{table}
%
%\subsection{Timelocks for ICO}
%https://blog.openzeppelin.com/bypassing-smart-contract-timelocks
%
%\subsection{Timelocks}
%A timelock is a smart contract that serves as a mechanism to delay function calls form another contract for
%a predefined amount of time. Timelocks find their primary application in governance systems,
%where they play a crucial role in implementing delayed administrative actions.
%Their presence often signifies the credibility of a project and underscores the commitment of its owners
%to its long-term success. \cite{timelock2021}.
%
%Openzeppelin provides such a timelock in their library (@openzeppelin/contracts/governance/TimelockController.sol).
%A part of this timelock code can be seen in Listing \ref{lst:timelock} \cite{timelock_code}.
%
%\lstinputlisting[language=Solidity, caption={Openzeppelin Timelock}, label={lst:timelock}]{../dev/contracts/timelock.sol}
%
%\subsection{State Machine}
%Contracts often act as a state machine. It's common to have multi-stage
%processes where certain actions are allowed only during specific phases.
%Timestamps can be used to enforce time-based conditions within a contract \cite{soliditydocs_statemaschine}. \\
%The following example shows a contract that implements the transition of stages (states) based on timestamps \cite{stagedcontract_code}.
%
%\begin{solidity}
%modifier timedTransitions() {
%    if (stage == Stages.AcceptingBlindBids && block.timestamp >= creationTime + 6 days) {
%        nextStage();
%    }
%    if (stage == Stages.RevealBids && block.timestamp >= creationTime + 10 days) {
%        nextStage();
%    }
%    _;
%}
%\end{solidity}

\newpage
\section{Best practices}
\subsection{Best practices under PoS}
\begin{itemize}
  \item Do not use block.number as a proxy for time.
  \item Do not use block.timestamp to trigger exact timings.
  \item Do not use block.timestamp in a comparison, instead use $>$ or $>=$.
  \item It is secure to use block.timestamp for time-dependent events, if it is acceptable for these events to occur later (12s, 24s, ...) than anticipated. \\
\end{itemize}

\subsection{Best practices under PoW}
\begin{itemize}
  \item Do not use block.number as a proxy for time.
  \item Do not use block.timestamp to trigger exact timings.
  \item It is secure to use block.timestamp for time-dependent events, if it is acceptable for these events to take place up to 15 seconds earlier than expected or later (until the next block). \\
\end{itemize}

\newpage
\section{Appendix}
\label{appendix}

\lstinputlisting[language=Solidity, caption={Firework Contract}, label={lst:Firework}]{../dev/contracts/firework.sol}
\lstinputlisting[language=Solidity, caption={FastWithdrawChallenge Contract}, label={lst:FastWithdrawChallenge}]{../dev/contracts/fastwithdrawchallenge.sol}
\lstinputlisting[language=Solidity, caption={BlockNumberTimeLock Contract}, label={lst:BlockNumberTimeLock}]{../dev/contracts/blocknumbertimelock.sol}
\lstinputlisting[language=Solidity, caption={BlockNumberLock Contract}, label={lst:BlockNumberLock}]{../dev/contracts/blocknumberlock.sol}
\lstinputlisting[language=Solidity, caption={Lottery Contract}, label={lst:Lottery}]{../dev/contracts/lottery.sol}
\lstinputlisting[language=Solidity, caption={StateMachine Contract}, label={lst:StateMachine}]{../dev/contracts/statemachine.sol}




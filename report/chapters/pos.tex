\section{Introduction}

Smart contracts often utilize time values to trigger specific actions. The
values that can be employed for this purpose include the block timestamp and
the block number. However, under the Proof of Work (PoW) consensus mechanism in
Ethereum, using these values has been associated with various security issues
\cite{swc116} \cite{Conkas2021} \cite{DASP2018} \cite{Osiris2018}
\cite{Oyente2016}.


Since the transition to the Proof of Stake (PoS) consensus mechanism in
Ethereum, significant changes have occurred in how the timestamp value has to
be set and in the stability of the block time. This paper aims to discuss these
changes.

%The block time is defined as the time difference between two consecutive blocks, calculated as the current block timestamp minus the timestamp of the parent block.

\section{Proof-of-Work}

\subsection{Block Time}

In PoW-based systems, a difficulty adjustment algorithm is employed to
determine the block time. If the block time was too short (less than 10
seconds), the difficulty level increased, and if the block time was too long
(greater than 20 seconds), the difficulty level decreased \cite{eip-2}.

\subsection{Block Timestamp}

As a result of the difficulty adjustment algorithm, the block time had the
potential to vary from one block to another. Furthermore, the only restriction
miners had to follow when setting the block timestamp value was outlined in the
yellow paper, which stipulated that the timestamp of the new block must be
greater than the timestamp of the parent block \cite{ethyellowpaper2023}.
Consequently, miners could gain an unfair advantage by manipulating the
timestamp of their mined block (references to be added).

%As a result of the difficulty adjustment algorithm, the block time had the potential to vary from one block to another.
%
%Furthermore the only restriction which miners had to follow when setting the 
%block timestamp value was the yellow paper. Which defined that the that
%the timestamp of the new block has to be greater than the timestamp of the
%parent block \cite{ethyellowpaper2023}. Hence miners could gain an unfair
%advantage by maniupulating the timestamp of their mined block (todo add
%references).

To prevent miners from setting the timestamp too far into the future, some of the most widely used Ethereum implementations, such as Geth (go-ethereum), implemented a rejection mechanism for blocks with timestamps exceeding 15 seconds into the future \cite{go-ethereum-15-sek-limit}.

Hence, when the PoW consensus mechanism was in use, miners had the ability to
manipulate the timestamp and adjust it by up to 15 seconds. This behavior led
to the establishment of the "15-second Rule"
\footnote{\url{https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/timestamp-dependence/}},
as a security best practice. The
rule suggests that the usage of the block timestamp is considered
safe if the time-dependent event can tolerate a variation of up to 15 seconds. 



\subsection{Block Number}

%The mining difficulty in those systems can
%vary and therefore the block time can also vary \cite{eth_blocks}. 
%
%Block times in PoW depended on how long a miner needed to brute-force a hash.
%It is possible to determine how long it takes to guess the right hash in
%average. But the actual time can vary. Also this hash had a certain difficulty
%which influences how long it takes to guess it correctly. This difficulty
%changed because of forks and because of the difficulty bomb. In conclusion this
%means that block times in PoW can vary quite much and are only 14 seconds in
%average.

\section{Proof-of-Stake}

\subsection{Block Time}

Since "The Merge" on September 15, 2022, Ethereum has transitioned to a
Proof-of-Stake (PoS) consensus protocol. In PoS Ethereum, new blocks are
proposed by validators, and then randomly selected validators must vote on the
validity of these proposed blocks. To become a validator, a deposit of 32 ETH
is required, stored in a deposit contract. Validators are incentivized to act
honestly as they risk losing a portion or all of their staked ETH if they
behave dishonestly.

Proof-of-stake Ethereum introduced the concepts of slots and epochs. Each slot
has a time frame of 12 seconds, and an epoch spans 32 slots
\cite{seconds-per-slot-mainnet}\cite{seconds-per-slot-mainnet-doc}. In each
slot, one validator is randomly chosen to propose a new block to the network.
Validators are required to adhere to the protocol's specifications when
creating new blocks; otherwise, their blocks will be rejected.

\subsection{Block Timestamp}

The PoS Ethereum consensus specification provides instructions on how to
calculate the timestamp at a specific slot using the
\textit{compute\_timestamp\_at\_slot} function \cite{compute-timestamp-at-slot}.
This calculation is based on the following formula:

\begin{equation}
genesis\_time + slots\_since\_genesis *
seconds\_per\_slot
\end{equation}


In the Ethereum mainnet configuration, the value of \textit{seconds\_per\_slot} is set to
12 seconds \cite{seconds-per-slot-mainnet} \cite{seconds-per-slot-mainnet-doc}.
The mainnet beacon chain's value for \textit{genesis\_time} is $1606824023$, which
corresponds to the timestamp when the original PoS beacon chain was launched on
December 1, 2020.

Each validator calculates the block timestamp in the same way and verifies if
the timestamp in the block matches the calculated timestamp. If there is a
mismatch, the block is rejected \cite{process-execution-payload}. Since each
slot, and consequently each block, has a predetermined timestamp, it is
virtually impossible to tamper with, but it also becomes more predictable. In
the event that the selected validator, responsible for proposing a new block,
is offline, the slot remains empty \cite{validator-offline}. The timestamp of
the following block aligns with the timestamp of the following slot, which is a
multiple of \textit{SECONDS\_PER\_SLOT}. As a result, blocks are 24 seconds
apart. If subsequent validators are also offline, the block times will be 36
seconds apart, and so on.

%Each validator calculates the block timestamp the same way and checks if
%timestamp in the block matches the calculated timestamp, if not the block will
%get rejected \cite{process-execution-payload}. Each slot and hence each block
%has a predetermined timestamp and is therefore impossible to tamper with but
%also much more easier to predict. If the selected validator to propose a new
%block is offline the slot remains empty \cite{validator-offline}. The following
%blocks timestamp has the timestamp of the following slot (i.e. a multiple of
%\textit{SECONDS\_PER\_SLOT}). In that case blocks will be 24 seconds apart. If
%the next proposed validator is also offline the block time will be 36 seconds
%apart etc.

\begin{figure}[H]
  \centering
  \includegraphics[width=1\textwidth]{../block_time_analysis/time_difference_bar.png}
  \caption{Block times since the merge.}
  \label{fig:block_time_analysis}
\end{figure}

Analysing blockchain data (refer to Figure \ref{fig:block_time_analysis}) following the
merge (block number $> 15537393$) shows that 99.05 \% of all blocks exhibit a
block time of 12 seconds.

\subsection{Block Number}


\section{Conclusion: Block Time under Proof-of-Work vs. Proof-of-Stake Ethereum}
\section{Best Practices (Dos and Donts)}


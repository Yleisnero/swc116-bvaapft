const timeTravelHelper = require("../helpers/time_travel_helper");
const TimeLock = artifacts.require("TimeLock");

contract("TimeLock test", async accounts => {
    let timeLock;

    beforeEach("deploy and init", async () => {
        timeLock = await TimeLock.new();
    });

    it("Withdraw should fail", async () => {
        const lockTime = 3600; // one hour
        const amount = 1000;
        console.log("Lock " + amount + " Wei for " + lockTime + " seconds");
        const retrievalTimestamp = await timeTravelHelper.getCurrentBlockTimestamp() + lockTime;
        console.log("Should be able to retrieve at: " + retrievalTimestamp);

        await timeLock.lockEth(lockTime, amount, { value: amount })

        await sleep(2000);

        // Simulate delay, takes longer then 14 seconds because of fork
        for (var i = 0; i < lockTime / 15; i++) {
            await timeTravelHelper.advanceTimeAndBlock(15);
            console.log("Mined new block: " + await timeTravelHelper.getCurrentBlockTimestamp());
        }

        // Try to withdraw
        try {
            console.log("Trying to withdraw. Timestamp: " + await timeTravelHelper.getCurrentBlockTimestamp());
            console.log("Retrieval timestamp: " + retrievalTimestamp);
            await timeLock.withdraw();

            assert.fail("The transaction should have thrown an error");
        }
        catch (err) {
            assert.include(err.message, "revert", "The error message should contain 'revert'");
        }
    });
});

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }